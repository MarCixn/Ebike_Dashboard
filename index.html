<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ebike">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon.svg">
    <title>Ebike Dashboard</title>
    <style>
        @font-face {
            font-family: 'nothing';
            src: url('nothing.ttf') format('truetype');
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #1a1a1a;
            font-family: 'nothing', sans-serif;
            color: #FFFFFF;
            margin: 0;
            padding: 5px;
            min-height: 100vh;
            min-height: 100dvh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Spacer to allow hiding address bar on mobile */
        body::after {
            content: '';
            display: block;
            height: 1px;
            margin-top: 50px;
        }

        /* ==================== MAIN LAYOUT ==================== */
        .dashboard {
            display: grid;
            gap: 5px;
            max-width: 1400px;
            margin: 0 auto;
            height: calc(100vh - 10px);
            height: calc(100dvh - 10px);
            position: sticky;
            top: 0;
            /* Mobile portrait: compact layout */
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr auto auto;
            grid-template-areas:
                "header header"
                "speed battery"
                "temps temps"
                "controls controls";
        }

        /* Tablet/Desktop landscape */
        @media (min-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr 2fr 1.5fr;
                grid-template-rows: 1fr 1fr auto;
                grid-template-areas:
                    "temps speed battery"
                    "temps speed battemps"
                    "controls controls stats";
            }
        }

        /* Mobile landscape (orientation-based for all phone sizes) */
        @media (orientation: landscape) and (max-height: 550px) {
            .dashboard {
                grid-template-columns: 0.8fr 2.2fr 1fr;
                grid-template-rows: 1fr 0.5fr auto;
                grid-template-areas:
                    "temps speed battery"
                    "temps speed battemps"
                    "controls controls controls";
                padding: 5px;
                gap: 2px;
            }
        }

        /* ==================== HEADER ==================== */
        .header {
            grid-area: header;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 10px;
            border-bottom: 1px solid #333;
            min-height: 30px;
        }

        @media (min-width: 768px) {
            .header {
                display: none;
            }
        }

        @media (orientation: landscape) and (max-height: 550px) {
            .header {
                display: none;
            }
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dot {
            width: 8px;
            height: 8px;
            background: #4caf50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .dot.disconnected {
            background: #ff4444;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .ble-status {
            font-size: 12px;
            color: #888;
            cursor: pointer;
        }

        .ble-status.connected {
            color: #4caf50;
        }

        .menu-btn {
            font-size: 20px;
            cursor: pointer;
            padding: 5px 10px;
        }

        /* ==================== SPEED GAUGE ==================== */
        .speed-section {
            grid-area: speed;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .speed-gauge {
            position: relative;
            width: min(200px, 45vw);
            height: min(200px, 45vw);
        }

        @media (min-width: 768px) {
            .speed-gauge {
                width: 280px;
                height: 280px;
            }
        }

        @media (orientation: landscape) and (max-height: 550px) {
            .speed-gauge {
                width: min(380px, 75vh) !important;
                height: min(380px, 75vh) !important;
                transform: translateX(-70px);
            }
        }

        .speed-gauge svg {
            width: 100%;
            height: 100%;
        }

        .SPEED-circle {
            transition: stroke-dashoffset 0.4s linear;
        }

        .progress-text {
            text-anchor: middle;
            dominant-baseline: middle;
            fill: #FFFFFF;
        }

        /* ==================== BATTERY ==================== */
        .battery-section {
            grid-area: battery;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        /* Landscape phones and tablets - battery positioning */
        @media (orientation: landscape) and (max-height: 550px) {
            .battery-section {
                justify-content: flex-start !important;
                align-items: center !important;
                padding: 0 !important;
            }
            .battery-gauge {
                transform: translate(-100px, 40px) !important;
            }
        }

        .battery-gauge {
            width: min(130px, 35vw);
            height: min(130px, 35vw);
        }

        @media (min-width: 768px) {
            .battery-gauge {
                width: 160px;
                height: 160px;
            }
        }

        @media (orientation: landscape) and (max-height: 550px) {
            .battery-gauge {
                width: min(160px, 30vh) !important;
                height: min(160px, 30vh) !important;
            }
        }

        .battery-gauge svg {
            width: 100%;
            height: 100%;
        }

        .BATT-circle {
            transition: stroke 0.4s linear, stroke-dashoffset 0.4s linear;
        }

        /* ==================== TEMPERATURES ==================== */
        .temps-section {
            grid-area: temps;
            display: flex;
            flex-direction: row;
            justify-content: space-around;
            align-items: center;
            padding: 5px;
            gap: 5px;
        }

        @media (min-width: 768px) {
            .temps-section {
                flex-direction: column;
                justify-content: center;
                gap: 15px;
                padding: 10px;
            }
        }

        @media (orientation: landscape) and (max-height: 550px) {
            .temps-section {
                flex-direction: column;
                gap: 12px;
            }
            .temp-label { font-size: 12px; }
            .temp-value { font-size: 24px; }
            .temp-line { width: 70px; }
        }

        .temp-item {
            text-align: center;
        }

        .temp-label {
            font-size: 8px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .temp-line {
            width: 40px;
            height: 1px;
            background: linear-gradient(90deg, transparent, #444, transparent);
            margin: 3px auto;
        }

        .temp-value {
            font-size: 14px;
        }

        @media (min-width: 768px) {
            .temp-label { font-size: 12px; }
            .temp-value { font-size: 24px; }
            .temp-line { width: 80px; }
        }

        /* ==================== BATTERY TEMPS ==================== */
        .battemps-section {
            grid-area: battemps;
            display: none;
            justify-content: flex-start;
            align-items: flex-start;
            gap: 10px;
            padding: 5px;
        }

        @media (min-width: 768px) {
            .battemps-section {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 15px;
                padding: 10px;
            }
        }

        @media (orientation: landscape) and (max-height: 550px) {
            .battemps-section {
                display: flex !important;
                justify-content: flex-start !important;
                align-items: flex-start !important;
                padding: 0 !important;
                transform: translate(-100px, 70px) !important;
            }
            .battemp-container {
                width: 26px !important;
                height: 100px !important;
            }
            .battemp-label {
                font-size: 10px !important;
            }
            .battemp-value {
                font-size: 12px !important;
            }
        }

        /* Mobile: hide battemps in temps section */
        .battemps-mobile {
            display: none;
        }

        .battemp-container {
            width: 16px;
            height: 60px;
            background-color: #222;
            border-radius: 8px;
            position: relative;
            overflow: visible;
            border: 1px solid #333;
        }

        .battemp-container::before {
            content: '';
            position: absolute;
            right: -10px;
            top: 0;
            width: 4px;
            height: 100%;
            background: repeating-linear-gradient(
                to bottom,
                #444 0px,
                #444 2px,
                transparent 2px,
                transparent 20%
            );
        }

        .battemp-container::after {
            content: 'Â· Â· Â·';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) rotate(90deg);
            font-size: 8px;
            color: #333;
            letter-spacing: 4px;
            pointer-events: none;
        }

        @media (min-width: 768px) {
            .battemp-container {
                width: 20px;
                height: 80px;
                border-radius: 10px;
            }
        }

        .battemp-bar {
            width: 100%;
            background-color: white;
            position: absolute;
            bottom: 0;
            border-radius: 0 0 6px 6px;
            transition: height 0.3s ease, background-color 0.3s ease;
            z-index: 2;
        }

        .battemps-title {
            font-size: 10px;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 1px;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
            margin-right: 8px;
        }

        .battemp-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .battemp-label {
            font-size: 8px;
            color: #555;
            text-transform: uppercase;
            margin-bottom: 3px;
        }

        .consumption-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-left: 15px;
            padding-left: 15px;
            border-left: 1px solid #333;
        }

        .consumption-label {
            font-size: 8px;
            font-family: 'nothing', sans-serif;
            color: #444;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .consumption-value {
            font-size: 22px;
            font-family: 'nothing', sans-serif;
            color: #fff;
            margin: 5px 0;
        }

        .consumption-unit {
            font-size: 9px;
            font-family: 'nothing', sans-serif;
            color: #555;
        }

        .battemp-value {
            font-size: 8px;
            text-align: center;
            margin-top: 3px;
            color: #888;
        }

        @media (min-width: 768px) {
            .battemp-value {
                font-size: 10px;
                margin-top: 5px;
            }
        }

        /* ==================== CONTROLS ==================== */
        .controls-section {
            grid-area: controls;
            padding: 5px 10px;
        }

        .control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .distance-display {
            display: flex;
            justify-content: center;
            gap: 15px;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .distance-item {
            text-align: center;
        }

        .distance-label {
            font-size: 8px;
            color: #666;
        }

        .distance-value {
            font-size: 14px;
        }

        @media (min-width: 768px) {
            .controls-section { padding: 15px; }
            .distance-display { font-size: 14px; margin-bottom: 15px; }
            .distance-label { font-size: 10px; }
            .distance-value { font-size: 16px; }
        }

        @media (orientation: landscape) and (max-height: 550px) {
            .controls-section {
                transform: translateX(-85px);
            }
        }

        .speed-limit-section {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
        }

        .speed-limit-toggle {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .speed-limit-btn {
            width: 50px;
            height: 50px;
            background: transparent;
            border: 2px solid #333;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: relative;
        }

        .speed-limit-btn svg {
            width: 28px;
            height: 28px;
            transition: all 0.2s;
        }

        .speed-limit-btn .limit-circle {
            fill: none;
            stroke: #444;
            stroke-width: 2;
        }

        .speed-limit-btn .limit-needle {
            fill: none;
            stroke: #444;
            stroke-width: 2;
            stroke-linecap: round;
        }

        .speed-limit-btn .limit-line {
            stroke: #444;
            stroke-width: 2;
            stroke-linecap: round;
            opacity: 0.3;
        }

        .speed-limit-btn.active {
            border-color: #00cc66;
        }

        .speed-limit-btn.active .limit-circle {
            stroke: #00cc66;
        }

        .speed-limit-btn.active .limit-needle {
            stroke: #00cc66;
        }

        .speed-limit-btn.active .limit-line {
            stroke: #00cc66;
            opacity: 1;
        }

        .speed-limit-btn:active {
            transform: scale(0.95);
        }

        .speed-limit-label {
            font-size: 8px;
            color: #444;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .slider-container {
            position: relative;
            width: 100%;
            max-width: 280px;
        }

        .slider-title {
            font-size: 8px;
            color: #444;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
            margin-bottom: 10px;
        }

        .slider-title::before,
        .slider-title::after {
            content: 'Â·';
            margin: 0 5px;
            color: #333;
        }

        .slider-track {
            height: 6px;
            background: #222;
            border-radius: 3px;
            position: relative;
            border: 1px solid #333;
        }

        .slider-ticks {
            position: absolute;
            top: -8px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 2px;
        }

        .slider-tick {
            width: 1px;
            height: 4px;
            background: #333;
        }

        .slider-tick:nth-child(5n+1) {
            height: 6px;
            background: #444;
        }

        .slider-fill {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            border-radius: 3px;
            transition: width 0.1s ease;
        }

        .slider-input {
            width: 100%;
            appearance: none;
            background: transparent;
            position: absolute;
            top: 14px;
            left: 0;
            height: 20px;
            margin: 0;
            cursor: pointer;
        }

        .slider-input::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .slider-input:active::-webkit-slider-thumb {
            transform: scale(1.1);
        }

        .slider-value-display {
            font-size: 14px;
            color: #fff;
            text-align: center;
            margin-top: 10px;
        }

        .slider-value-display span {
            color: #4caf50;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 8px;
            color: #333;
        }

        @media (min-width: 768px) {
            .slider-container {
                max-width: 320px;
            }
            .slider-value-display {
                font-size: 16px;
            }
        }

        @media (orientation: landscape) and (max-height: 550px) {
            .speed-limit-btn {
                width: 45px;
                height: 45px;
            }
            .slider-container {
                max-width: 260px;
            }
        }

        /* ==================== STATS ==================== */
        .stats-section {
            grid-area: stats;
            display: none;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 10px;
        }

        @media (min-width: 768px) {
            .stats-section {
                display: flex;
            }
        }

        /* ==================== BLE BUTTON ==================== */
        .ble-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 25px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            z-index: 100;
            transition: background 0.2s;
        }

        .ble-button:hover {
            background: #333;
        }

        .ble-button.connected {
            border-color: #4caf50;
        }

        .ble-dot {
            width: 10px;
            height: 10px;
            background: #ff4444;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .ble-button.connected .ble-dot {
            background: #4caf50;
            animation: pulse 2s infinite;
        }

        /* Menu button */
        .menu-button {
            position: fixed;
            top: 20px;
            right: 120px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            font-size: 20px;
        }

        .menu-button:hover {
            background: #333;
        }

        @media (max-width: 767px) {
            .ble-button {
                display: none;
            }
            .menu-button {
                display: none;
            }
        }

        /* ==================== GEAR DISPLAY ==================== */
        .gear-display {
            position: fixed;
            top: 55%;
            right: 5px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            z-index: 100;
        }

        .gear-btn {
            width: 60px;
            height: 60px;
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 15px;
            color: #666;
            font-size: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            position: relative;
        }

        .gear-btn::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 2px;
            background: #444;
        }

        .gear-btn.plus::before {
            content: '';
            position: absolute;
            width: 2px;
            height: 20px;
            background: #444;
        }

        .gear-btn:active {
            background: #222;
            border-color: #4caf50;
            transform: scale(0.95);
        }

        .gear-btn:active::after,
        .gear-btn:active::before {
            background: #4caf50;
        }

        .gear-number {
            font-size: 28px;
            min-width: 30px;
            text-align: center;
            color: #fff;
            padding: 5px 0;
        }

        .gear-mode {
            font-size: 9px;
            font-family: 'nothing', sans-serif;
            color: #555;
            background: transparent;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 6px 12px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
            margin-top: 30px;
        }

        .gear-mode:active {
            border-color: #555;
        }

        .gear-mode.auto {
            color: #4caf50;
            border-color: #4caf50;
        }

        .gear-title {
            font-size: 10px;
            font-family: 'nothing', sans-serif;
            color: #444;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 5px;
            position: relative;
        }

        .gear-title::before,
        .gear-title::after {
            content: 'Â·';
            margin: 0 5px;
            color: #333;
        }

        @media (min-width: 768px) {
            .gear-display {
                right: 15px;
                gap: 8px;
            }
            .gear-btn {
                width: 70px;
                height: 70px;
                font-size: 32px;
            }
            .gear-number {
                font-size: 36px;
            }
        }

        @media (orientation: landscape) and (max-height: 550px) {
            .gear-display {
                right: 8px;
                gap: 4px;
            }
            .gear-btn {
                width: 69px;
                height: 69px;
                border-radius: 12px;
            }
            .gear-btn::after {
                width: 26px;
                height: 3px;
            }
            .gear-btn.plus::before {
                width: 3px;
                height: 26px;
            }
            .gear-number {
                font-size: 32px;
            }
            .gear-mode {
                font-size: 10px;
                padding: 8px 14px;
                margin-top: 25px;
            }
            .gear-title {
                font-size: 9px;
                letter-spacing: 2px;
            }
        }

        /* ==================== BOTTOM LEFT CONTROLS ==================== */
        .bottom-left-controls {
            position: fixed;
            bottom: 15px;
            left: 15px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
            z-index: 100;
        }

        /* ==================== LOCK BUTTON ==================== */
        .lock-btn {
            background: transparent;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }

        .lock-btn:active {
            border-color: #555;
            background: #222;
        }

        .lock-btn.locked {
            border-color: #ff4444;
        }

        .lock-icon-display {
            width: 20px;
            height: 24px;
            position: relative;
        }

        .lock-body {
            position: absolute;
            bottom: 0;
            left: 2px;
            width: 16px;
            height: 12px;
            background: #444;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .lock-btn.locked .lock-body {
            background: #ff4444;
        }

        .lock-shackle {
            position: absolute;
            top: 0;
            left: 5px;
            width: 10px;
            height: 12px;
            border: 2px solid #444;
            border-bottom: none;
            border-radius: 6px 6px 0 0;
            transition: all 0.2s;
        }

        .lock-btn.locked .lock-shackle {
            border-color: #ff4444;
        }

        .lock-btn:not(.locked) .lock-shackle {
            transform: translateY(-3px) rotate(15deg);
            transform-origin: bottom right;
        }

        .lock-text {
            font-size: 10px;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'nothing', sans-serif;
        }

        .lock-btn.locked .lock-text {
            color: #ff4444;
        }

        @media (min-width: 768px) {
            .lock-btn {
                bottom: 20px;
                left: 20px;
                padding: 12px 18px;
            }
            .lock-text {
                font-size: 11px;
            }
        }

        @media (orientation: landscape) and (max-height: 550px) {
            .lock-btn {
                padding: 8px 12px;
                gap: 8px;
            }
            .lock-icon-display {
                width: 18px;
                height: 22px;
            }
            .lock-body {
                width: 14px;
                height: 10px;
            }
            .lock-shackle {
                width: 8px;
                height: 10px;
            }
            .lock-text {
                font-size: 9px;
            }
        }

        /* ==================== PAS DISPLAY ==================== */
        .pas-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .pas-label {
            font-size: 8px;
            font-family: 'nothing', sans-serif;
            color: #444;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .pas-level-btn {
            width: 50px;
            height: 50px;
            background: transparent;
            border: 2px solid #333;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .pas-level-btn:active {
            border-color: #4caf50;
            transform: scale(0.95);
        }

        .pas-level-value {
            font-size: 22px;
            font-family: 'nothing', sans-serif;
            color: #4caf50;
        }

        .pas-only-btn {
            background: transparent;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 5px 10px;
            cursor: pointer;
            font-family: 'nothing', sans-serif;
            font-size: 8px;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
        }

        .pas-only-btn:active {
            background: #222;
        }

        .pas-only-btn.active {
            border-color: #4caf50;
            color: #4caf50;
        }

        @media (min-width: 768px) {
            .bottom-left-controls {
                bottom: 20px;
                left: 20px;
            }
            .pas-level-btn {
                width: 55px;
                height: 55px;
            }
            .pas-level-value {
                font-size: 24px;
            }
        }

        @media (orientation: landscape) and (max-height: 550px) {
            .bottom-left-controls {
                bottom: 10px;
                left: 10px;
                gap: 8px;
            }
            .pas-level-btn {
                width: 45px;
                height: 45px;
            }
            .pas-level-value {
                font-size: 20px;
            }
            .pas-only-btn {
                font-size: 7px;
                padding: 4px 8px;
            }
        }

        /* ==================== POWER MODE BUTTON ==================== */
        .power-mode-btn {
            position: fixed;
            bottom: 70px;
            left: 15px;
            background: transparent;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 10px 15px;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            font-family: 'nothing', sans-serif;
        }

        .power-mode-btn:active {
            border-color: #555;
            background: #222;
        }

        .power-mode-icon {
            font-size: 16px;
        }

        .power-mode-text {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .power-mode-btn.eco {
            border-color: #4caf50;
        }
        .power-mode-btn.eco .power-mode-text {
            color: #4caf50;
        }

        .power-mode-btn.normal {
            border-color: #2196f3;
        }
        .power-mode-btn.normal .power-mode-text {
            color: #2196f3;
        }

        .power-mode-btn.sport {
            border-color: #ff9800;
        }
        .power-mode-btn.sport .power-mode-text {
            color: #ff9800;
        }

        .power-mode-btn.turbo {
            border-color: #f44336;
        }
        .power-mode-btn.turbo .power-mode-text {
            color: #f44336;
        }

        .power-mode-btn.off {
            border-color: #666;
            background: #222;
        }
        .power-mode-btn.off .power-mode-text {
            color: #666;
        }
        .power-mode-btn.off .power-mode-icon {
            opacity: 0.3;
        }

        @media (min-width: 768px) {
            .power-mode-btn {
                bottom: 80px;
                left: 20px;
                padding: 12px 18px;
            }
        }

        @media (orientation: landscape) and (max-height: 550px) {
            .power-mode-btn {
                bottom: 60px;
                left: 10px;
                padding: 8px 12px;
            }
            .power-mode-icon {
                font-size: 14px;
            }
            .power-mode-text {
                font-size: 9px;
            }
        }

        /* ==================== LED QUICK BUTTON ==================== */
        .led-quick-btn {
            position: fixed;
            bottom: 130px;
            left: 15px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 10px 15px;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-family: 'nothing', sans-serif;
        }

        .led-quick-btn:active {
            border-color: #00ffff;
            background: linear-gradient(135deg, #0a0a1e 0%, #162050 100%);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }

        .led-icon {
            font-size: 16px;
        }

        .led-mode-text {
            color: #00ffff;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        @media (min-width: 768px) {
            .led-quick-btn {
                bottom: 140px;
                left: 20px;
                padding: 12px 18px;
            }
        }

        @media (orientation: landscape) and (max-height: 550px) {
            .led-quick-btn {
                bottom: 110px;
                left: 10px;
                padding: 8px 12px;
            }
            .led-icon {
                font-size: 14px;
            }
            .led-mode-text {
                font-size: 9px;
            }
        }

        /* ==================== SIDE MENU ==================== */
        .sidenav {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 200;
            top: 0;
            right: 0;
            background-color: #111;
            overflow-x: hidden;
            overflow-y: auto;
            transition: 0.3s;
            padding-top: 60px;
        }

        .sidenav-content {
            padding: 20px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .sidenav.open .sidenav-content {
            opacity: 1;
        }

        .sidenav .closebtn {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 36px;
            cursor: pointer;
            color: #888;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-title {
            font-size: 14px;
            color: #4caf50;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #333;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #222;
        }

        .settings-label {
            color: #888;
            font-size: 14px;
        }

        .settings-value {
            color: #fff;
            font-size: 14px;
        }

        .settings-input {
            background: #222;
            border: 1px solid #444;
            color: #fff;
            padding: 8px 12px;
            border-radius: 5px;
            font-family: 'nothing', sans-serif;
            width: 100px;
            text-align: right;
        }

        .settings-btn {
            background: #333;
            border: 1px solid #555;
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            font-family: 'nothing', sans-serif;
            cursor: pointer;
            transition: background 0.2s;
        }

        /* LED Preset Buttons */
        .led-preset-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            color: #fff;
            font-family: 'nothing', sans-serif;
            font-size: 11px;
            cursor: pointer;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            transition: transform 0.1s, box-shadow 0.2s;
        }

        .led-preset-btn:active {
            transform: scale(0.95);
        }

        .led-preset-btn:hover {
            box-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        /* Gradient Color Inputs */
        .gradient-color {
            width: 40px;
            height: 40px;
            border: 2px solid #555;
            border-radius: 8px;
            padding: 0;
            cursor: pointer;
            transition: transform 0.1s, border-color 0.2s;
        }

        .gradient-color:hover {
            border-color: #888;
            transform: scale(1.1);
        }

        /* Range inputs styling */
        input[type="range"] {
            -webkit-appearance: none;
            background: #333;
            border-radius: 5px;
            height: 8px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #00ffff;
            border-radius: 50%;
            cursor: pointer;
        }

        .settings-btn:active {
            background: #4caf50;
        }

        .settings-btn.danger {
            border-color: #ff4444;
            color: #ff4444;
        }

        .settings-btn.danger:active {
            background: #ff4444;
            color: #fff;
        }

        /* Toggle switch */
        .toggle {
            width: 50px;
            height: 26px;
            background: #333;
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle.active {
            background: #4caf50;
        }

        .toggle::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .toggle.active::after {
            transform: translateX(24px);
        }

        /* ==================== LOCK SCREEN ==================== */
        .lock-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #111;
            z-index: 300;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .lock-screen.active {
            display: flex;
        }

        .lock-screen-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 30px;
            border: 1px solid #333;
            border-radius: 20px;
            background: rgba(20, 20, 20, 0.8);
        }

        .lock-icon {
            font-size: 48px;
        }

        .pin-title {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .pin-display {
            font-size: 32px;
            letter-spacing: 10px;
            min-height: 40px;
        }

        .pin-pad {
            display: grid;
            grid-template-columns: repeat(3, 70px);
            gap: 15px;
        }

        .pin-btn {
            width: 70px;
            height: 70px;
            background: #222;
            border: 1px solid #444;
            border-radius: 50%;
            color: #fff;
            font-size: 24px;
            font-family: 'nothing', sans-serif;
            cursor: pointer;
            transition: background 0.2s;
        }

        .pin-btn:active {
            background: #4caf50;
        }

        .pin-btn.clear {
            color: #ff6666;
            border-color: #552222;
        }

        .pin-btn.clear:active {
            background: #ff4444;
            color: #fff;
        }

        .pin-btn.submit {
            color: #66ff66;
            border-color: #225522;
        }

        .pin-btn.submit:active {
            background: #4caf50;
            color: #fff;
        }

        /* Landscape mode for lock screen */
        @media (orientation: landscape) and (max-height: 550px) {
            .lock-screen {
                flex-direction: row;
                gap: 50px;
                padding: 10px;
            }

            .lock-screen-content {
                flex-direction: column;
                gap: 8px;
                padding: 20px 30px;
            }

            .lock-icon {
                font-size: 40px;
            }

            .pin-title {
                font-size: 12px;
            }

            .pin-display {
                font-size: 28px;
                letter-spacing: 8px;
                min-height: 35px;
            }

            .pin-pad {
                grid-template-columns: repeat(3, 60px);
                gap: 10px;
            }

            .pin-btn {
                width: 60px;
                height: 60px;
                font-size: 22px;
            }
        }

        /* Very small landscape screens */
        @media (orientation: landscape) and (max-height: 400px) {
            .lock-screen {
                gap: 20px;
            }

            .lock-screen-content {
                padding: 15px 25px;
            }

            .lock-icon {
                font-size: 28px;
            }

            .pin-title {
                font-size: 10px;
            }

            .pin-display {
                font-size: 20px;
            }

            .pin-pad {
                grid-template-columns: repeat(3, 45px);
                gap: 5px;
            }

            .pin-btn {
                width: 45px;
                height: 45px;
                font-size: 16px;
            }
        }

        /* ==================== FULLSCREEN BUTTON ==================== */
        .fullscreen-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 45px;
            height: 45px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 50%;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fullscreen-btn:active {
            background: #4caf50;
        }

        .fullscreen-btn.active {
            background: #333;
            border-color: #4caf50;
        }

        /* ==================== NOTHING STYLE DOTS ==================== */
        .nothing-dots {
            display: flex;
            gap: 4px;
            justify-content: center;
            margin: 10px 0;
        }

        .nothing-dot {
            width: 4px;
            height: 4px;
            background: #444;
            border-radius: 50%;
        }

        .nothing-dot.active {
            background: #4caf50;
        }
    </style>
</head>
<body>
    <!-- LOCK SCREEN -->
    <div class="lock-screen" id="lockScreen">
        <div class="lock-screen-content">
            <div class="lock-icon">ðŸ”’</div>
            <div class="pin-title">Enter PIN</div>
            <div class="pin-display" id="pinDisplay"></div>
        </div>
        <div class="pin-pad">
            <button class="pin-btn" onclick="enterPin(1)">1</button>
            <button class="pin-btn" onclick="enterPin(2)">2</button>
            <button class="pin-btn" onclick="enterPin(3)">3</button>
            <button class="pin-btn" onclick="enterPin(4)">4</button>
            <button class="pin-btn" onclick="enterPin(5)">5</button>
            <button class="pin-btn" onclick="enterPin(6)">6</button>
            <button class="pin-btn" onclick="enterPin(7)">7</button>
            <button class="pin-btn" onclick="enterPin(8)">8</button>
            <button class="pin-btn" onclick="enterPin(9)">9</button>
            <button class="pin-btn clear" onclick="clearPin()">C</button>
            <button class="pin-btn" onclick="enterPin(0)">0</button>
            <button class="pin-btn submit" onclick="submitPin()">OK</button>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div class="dashboard">
        <!-- Header (mobile only) -->
        <div class="header">
            <div class="header-left">
                <div class="dot" id="bleDot"></div>
                <span class="ble-status" id="bleStatus" onclick="connectBLE()">Connect</span>
            </div>
            <span class="menu-btn" onclick="openNav()">â˜°</span>
        </div>

        <!-- Speed Gauge -->
        <div class="speed-section">
            <div class="speed-gauge">
                <svg viewBox="0 0 140 140">
                    <circle cx="70" cy="70" r="60" fill="#222" stroke="#333" stroke-width="0.5"/>
                    <!-- Ozdoby - ticki na zewnÄ…trz -->
                    <rect x="69.5" y="5" width="1" height="7" fill="#444"/>
                    <rect x="69.5" y="128" width="1" height="7" fill="#444"/>
                    <rect x="5" y="69.5" width="7" height="1" fill="#444"/>
                    <rect x="128" y="69.5" width="7" height="1" fill="#444"/>
                    <!-- KoÅ‚a progress -->
                    <circle cx="70" cy="70" r="50" fill="#222" stroke="#333" stroke-width="5"/>
                    <circle class="SPEED-circle" cx="70" cy="70" r="50" fill="none" stroke="#4caf50" stroke-width="5"
                            stroke-dasharray="314.16" stroke-dashoffset="314.16" transform="rotate(45, 70, 70)"/>
                    <!-- Ozdoby szare - przerywniki -->
                    <rect x="67.5" y="16" width="5" height="8" fill="#222"/>
                    <rect x="67.5" y="116" width="5" height="8" fill="#222"/>
                    <rect x="116" y="67.5" width="8" height="5" fill="#222"/>
                    <rect x="16" y="67.5" width="8" height="5" fill="#222"/>
                    <rect x="16" y="67.5" width="8" height="5" fill="#222" transform="rotate(45 70 70)"/>
                    <rect x="16" y="67.5" width="8" height="5" fill="#222" transform="rotate(135 70 70)"/>
                    <rect x="16" y="67.5" width="8" height="5" fill="#222" transform="rotate(225 70 70)"/>
                    <rect x="16" y="67.5" width="8" height="5" fill="#222" transform="rotate(315 70 70)"/>
                    <!-- Text -->
                    <text x="70" y="40" class="progress-text" font-size="7" fill="#666">SPEED</text>
                    <text x="54" y="62" class="progress-text" id="progressSPEED" font-size="23" fill="#4caf50">0</text>
                    <text x="85" y="64" class="progress-text" font-size="12" fill="#888">km/h</text>
                    <text x="70" y="80" class="progress-text" font-size="7" fill="#666">CURRENT</text>
                    <rect x="47" y="85" width="45" height="0.3" fill="#333"/>
                    <text x="70" y="97" class="progress-text" id="progressCURRENT" font-size="13" fill="#fff">0.00 A</text>
                </svg>
            </div>
        </div>

        <!-- Battery Gauge -->
        <div class="battery-section">
            <div class="battery-gauge">
                <svg viewBox="0 0 140 140">
                    <circle cx="70" cy="70" r="60" fill="#222" stroke="#333" stroke-width="0.5"/>
                    <!-- KoÅ‚a progress -->
                    <circle cx="70" cy="70" r="45" fill="#222" stroke="#333" stroke-width="10"/>
                    <circle class="BATT-circle" cx="70" cy="70" r="45" fill="none" stroke="#4caf50" stroke-width="10"
                            stroke-dasharray="282.74" stroke-dashoffset="282.74" transform="rotate(45, 70, 70)"/>
                    <!-- Ozdoby szare - przerywniki -->
                    <rect x="64.5" y="19" width="10" height="12" fill="#222"/>
                    <rect x="64.5" y="109" width="10" height="12" fill="#222"/>
                    <rect x="109" y="64.5" width="12" height="10" fill="#222"/>
                    <rect x="19" y="64.5" width="12" height="10" fill="#222"/>
                    <rect x="19" y="64.5" width="12" height="10" fill="#222" transform="rotate(225 70 70)"/>
                    <!-- Text -->
                    <text x="70" y="50" class="progress-text" font-size="8" fill="#666">BATTERY</text>
                    <rect x="45" y="55" width="50" height="0.3" fill="#333"/>
                    <text x="70" y="72" class="progress-text" id="progressBAT" font-size="12" fill="#fff">0.0v</text>
                    <text x="70" y="90" class="progress-text" id="progressBATPRO" font-size="14" fill="#4caf50">0%</text>
                </svg>
            </div>
        </div>

        <!-- Temperatures -->
        <div class="temps-section">
            <div class="temp-item">
                <div class="temp-label">Engine</div>
                <div class="temp-line"></div>
                <div class="temp-value" id="tempENGINE">--Â°c</div>
            </div>
            <div class="temp-item">
                <div class="temp-label">Controller</div>
                <div class="temp-line"></div>
                <div class="temp-value" id="tempCONTROLLER">--Â°c</div>
            </div>
            <div class="temp-item">
                <div class="temp-label">Outdoor</div>
                <div class="temp-line"></div>
                <div class="temp-value" id="tempOUTDOR">--Â°c</div>
            </div>
            <!-- Battery temps on mobile -->
            <div class="battemps-mobile">
                <div>
                    <div class="battemp-container"><div id="battempprogres1" class="battemp-bar"></div></div>
                    <div class="battemp-value" id="battemp1">--Â°c</div>
                </div>
                <div>
                    <div class="battemp-container"><div id="battempprogres2" class="battemp-bar"></div></div>
                    <div class="battemp-value" id="battemp2">--Â°c</div>
                </div>
                <div>
                    <div class="battemp-container"><div id="battempprogres3" class="battemp-bar"></div></div>
                    <div class="battemp-value" id="battemp3">--Â°c</div>
                </div>
                <div>
                    <div class="battemp-container"><div id="battempprogres4" class="battemp-bar"></div></div>
                    <div class="battemp-value" id="battemp4">--Â°c</div>
                </div>
            </div>
        </div>

        <!-- Battery temps desktop -->
        <div class="battemps-section">
            <div class="battemps-title">Bat sensors</div>
            <div class="battemp-item">
                <div class="battemp-label">B1</div>
                <div class="battemp-container"><div id="battempprogres1d" class="battemp-bar"></div></div>
                <div class="battemp-value" id="battemp1d">--Â°c</div>
            </div>
            <div class="battemp-item">
                <div class="battemp-label">B2</div>
                <div class="battemp-container"><div id="battempprogres2d" class="battemp-bar"></div></div>
                <div class="battemp-value" id="battemp2d">--Â°c</div>
            </div>
            <div class="battemp-item">
                <div class="battemp-label">B3</div>
                <div class="battemp-container"><div id="battempprogres3d" class="battemp-bar"></div></div>
                <div class="battemp-value" id="battemp3d">--Â°c</div>
            </div>
            <div class="battemp-item">
                <div class="battemp-label">B4</div>
                <div class="battemp-container"><div id="battempprogres4d" class="battemp-bar"></div></div>
                <div class="battemp-value" id="battemp4d">--Â°c</div>
            </div>
            <div class="consumption-display">
                <div class="consumption-label">Â· Avg Â·</div>
                <div class="consumption-value" id="avgConsumption">--</div>
                <div class="consumption-unit">Wh/km</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-section">
            <div class="distance-display">
                <div class="distance-item">
                    <div class="distance-label">TOTAL</div>
                    <div class="distance-value" id="totalDistance">0 km</div>
                </div>
                <div style="color:#333">|</div>
                <div class="distance-item">
                    <div class="distance-label">TRIP</div>
                    <div class="distance-value" id="tripDistance">0 km</div>
                </div>
            </div>
            <div class="speed-limit-section">
                <div class="speed-limit-toggle">
                    <button class="speed-limit-btn" id="speedLimitBtn" onclick="toggleSpeedLimit()">
                        <svg viewBox="0 0 24 24">
                            <!-- Speedometer arc -->
                            <path class="limit-circle" d="M4 18 A10 10 0 1 1 20 18"/>
                            <!-- Needle -->
                            <path class="limit-needle" d="M12 17 L16 9"/>
                            <!-- Limit stop line -->
                            <line class="limit-line" x1="17" y1="7" x2="20" y2="4"/>
                        </svg>
                    </button>
                    <span class="speed-limit-label">Limit</span>
                </div>
                <div class="slider-container">
                    <div class="slider-title">Â· Speed Limit Â·</div>
                    <div class="slider-track">
                        <div class="slider-ticks">
                            <div class="slider-tick"></div>
                            <div class="slider-tick"></div>
                            <div class="slider-tick"></div>
                            <div class="slider-tick"></div>
                            <div class="slider-tick"></div>
                            <div class="slider-tick"></div>
                            <div class="slider-tick"></div>
                            <div class="slider-tick"></div>
                            <div class="slider-tick"></div>
                            <div class="slider-tick"></div>
                            <div class="slider-tick"></div>
                        </div>
                        <div class="slider-fill" id="sliderFill"></div>
                    </div>
                    <input type="range" class="slider-input" id="maxSpeedSlider" min="0" max="100" value="50" oninput="updateMaxSpeed(this.value)">
                    <div class="slider-value-display" id="maxSpeedValue"><span>50</span> km/h</div>
                    <div class="slider-labels">
                        <span>0</span>
                        <span>50</span>
                        <span>100</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BLE BUTTON (desktop) -->
    <div class="ble-button" id="bleButton" onclick="connectBLE()">
        <div class="ble-dot" id="bleButtonDot"></div>
        <span id="bleButtonText">BLE</span>
    </div>

    <!-- MENU BUTTON (desktop) -->
    <div class="menu-button" onclick="openNav()">â˜°</div>

    <!-- FULLSCREEN BUTTON -->
    <button class="fullscreen-btn" id="fullscreenBtn" onclick="toggleFullscreen()">â›¶</button>

    <!-- GEAR CONTROL -->
    <div class="gear-display">
        <div class="gear-title">Gear</div>
        <button class="gear-btn plus" onclick="gearUp()"></button>
        <span class="gear-number" id="gearNumber">1</span>
        <button class="gear-btn" onclick="gearDown()"></button>
        <button class="gear-mode" id="gearMode" onclick="toggleGearMode()">manual</button>
    </div>

    <!-- BOTTOM LEFT CONTROLS -->
    <div class="bottom-left-controls">
        <!-- LOCK BUTTON -->
        <button class="lock-btn" id="lockBtn" onclick="toggleBikeLock()">
            <div class="lock-icon-display" id="lockIconDisplay">
                <div class="lock-body"></div>
                <div class="lock-shackle"></div>
            </div>
            <span class="lock-text" id="lockText">unlock</span>
        </button>

        <!-- PAS LEVEL DISPLAY -->
        <div class="pas-display" id="pasDisplay">
            <div class="pas-label">Â· PAS Â·</div>
            <button class="pas-level-btn" onclick="cyclePasLevel()">
                <span class="pas-level-value" id="pasLevelValue">5</span>
            </button>
            <button class="pas-only-btn" id="pasOnlyBtn" onclick="togglePasOnly()">
                <span id="pasOnlyText">PAS+T</span>
            </button>
        </div>
    </div>

    <!-- POWER MODE BUTTON -->
    <button class="power-mode-btn" id="powerModeBtn" onclick="cyclePowerMode()">
        <span class="power-mode-icon" id="powerModeIcon">âš¡</span>
        <span class="power-mode-text" id="powerModeText">normal</span>
    </button>

    <!-- LED QUICK BUTTON -->
    <button class="led-quick-btn" id="ledQuickBtn" onclick="cycleLedMode()">
        <span class="led-icon">ðŸ’¡</span>
        <span class="led-mode-text" id="ledModeText">gradient</span>
    </button>

    <!-- SIDE MENU -->
    <div id="mySidenav" class="sidenav">
        <span class="closebtn" onclick="closeNav()">Ã—</span>
        <div class="sidenav-content">
            <!-- Connection -->
            <div class="settings-section">
                <div class="settings-title">Connection</div>
                <div class="settings-item">
                    <span class="settings-label">Bluetooth</span>
                    <span class="settings-value" id="bleStatusMenu" onclick="connectBLE()" style="cursor:pointer">Connect</span>
                </div>
            </div>

            <!-- Wheel Settings -->
            <div class="settings-section">
                <div class="settings-title">Wheel</div>
                <div class="settings-item">
                    <span class="settings-label">Circumference (mm)</span>
                    <input type="number" class="settings-input" id="wheelCircum" value="2200" onchange="saveSettings()">
                </div>
                <div class="settings-item">
                    <span class="settings-label">Pulses/rev</span>
                    <input type="number" class="settings-input" id="wheelPulses" value="1" onchange="saveSettings()">
                </div>
            </div>

            <!-- Gears -->
            <div class="settings-section">
                <div class="settings-title">Gears (MXUS 3K)</div>
                <div class="settings-item">
                    <span class="settings-label">Number of gears</span>
                    <input type="number" class="settings-input" id="gearCount" min="1" max="8" value="8" onchange="updateGearInputs()">
                </div>
                <div id="gearPositions"></div>
                <div class="settings-item">
                    <button class="settings-btn" onclick="calibrateGear()">Calibrate Current</button>
                </div>
                <div class="settings-item">
                    <button class="settings-btn" onclick="finetuneGear()">Fine-tune Mode</button>
                </div>
            </div>

            <!-- Auto Gear -->
            <div class="settings-section">
                <div class="settings-title">Auto Gear</div>
                <div class="settings-item">
                    <span class="settings-label">Hysteresis (km/h)</span>
                    <input type="number" class="settings-input" id="gearHysteresis" min="1" max="10" value="3" onchange="saveSettings()">
                </div>
                <div id="gearSpeedThresholds"></div>
            </div>

            <!-- PAS Sensor -->
            <div class="settings-section">
                <div class="settings-title">PAS Sensor</div>
                <div class="settings-item">
                    <span class="settings-label">PAS enabled</span>
                    <div class="toggle active" id="pasToggle" onclick="togglePas()"></div>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Assist level (1-10)</span>
                    <input type="number" class="settings-input" id="pasLevel" min="1" max="10" value="5" onchange="saveSettings()">
                </div>
                <div class="settings-item">
                    <span class="settings-label">PAS magnets</span>
                    <input type="number" class="settings-input" id="pasMagnets" min="1" max="24" value="12" onchange="saveSettings()">
                </div>
            </div>

            <!-- Throttle -->
            <div class="settings-section">
                <div class="settings-title">Throttle</div>
                <div class="settings-item">
                    <span class="settings-label">Throttle enabled</span>
                    <div class="toggle active" id="throttleToggle" onclick="toggleThrottle()"></div>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Throttle curve</span>
                    <select class="settings-input" id="throttleCurve" onchange="saveSettings()" style="width:100px">
                        <option value="linear">Linear</option>
                        <option value="soft">Soft</option>
                        <option value="aggressive">Aggressive</option>
                    </select>
                </div>
            </div>

            <!-- Cruise Control -->
            <div class="settings-section">
                <div class="settings-title">Cruise Control</div>
                <div class="settings-item">
                    <span class="settings-label">Tempomat enabled</span>
                    <div class="toggle" id="cruiseToggle" onclick="toggleCruise()"></div>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Activation delay (s)</span>
                    <input type="number" class="settings-input" id="cruiseDelay" min="1" max="10" value="3" onchange="saveSettings()">
                </div>
            </div>

            <!-- Braking -->
            <div class="settings-section">
                <div class="settings-title">Braking</div>
                <div class="settings-item">
                    <span class="settings-label">Adaptive braking</span>
                    <div class="toggle" id="adaptiveBrakeToggle" onclick="toggleAdaptiveBrake()"></div>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Min battery for brake (%)</span>
                    <input type="number" class="settings-input" id="brakeMinBat" min="0" max="95" value="20" onchange="saveSettings()">
                </div>
                <div class="settings-item">
                    <span class="settings-label">Regen level (%)</span>
                    <input type="number" class="settings-input" id="regenLevel" min="0" max="100" value="30" onchange="saveSettings()">
                </div>
                <div class="settings-item">
                    <span class="settings-label">Trailer braking</span>
                    <div class="toggle" id="trailerToggle" onclick="toggleTrailer()"></div>
                </div>
            </div>

            <!-- Power Modes -->
            <div class="settings-section">
                <div class="settings-title">Power Mode</div>
                <div class="settings-item">
                    <span class="settings-label">Mode</span>
                    <select class="settings-input" id="powerMode" onchange="saveSettings()" style="width:100px">
                        <option value="off">OFF</option>
                        <option value="eco">Eco</option>
                        <option value="normal" selected>Normal</option>
                        <option value="sport">Sport</option>
                        <option value="turbo">Turbo</option>
                    </select>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Walk assist</span>
                    <div class="toggle" id="walkAssistToggle" onclick="toggleWalkAssist()"></div>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Reverse</span>
                    <div class="toggle" id="reverseToggle" onclick="toggleReverse()"></div>
                </div>
            </div>

            <!-- Limits -->
            <div class="settings-section">
                <div class="settings-title">Limits</div>
                <div class="settings-item">
                    <span class="settings-label">Max speed (km/h)</span>
                    <input type="number" class="settings-input" id="limitSpeed" value="90" onchange="saveSettings()">
                </div>
                <div class="settings-item">
                    <span class="settings-label">Max current (A)</span>
                    <input type="number" class="settings-input" id="limitCurrent" value="260" onchange="saveSettings()">
                </div>
                <div class="settings-item">
                    <span class="settings-label">Max phase current (A)</span>
                    <input type="number" class="settings-input" id="limitPhase" value="400" onchange="saveSettings()">
                </div>
                <div class="settings-item">
                    <span class="settings-label">Max temp (Â°C)</span>
                    <input type="number" class="settings-input" id="limitTemp" value="80" onchange="saveSettings()">
                </div>
                <div class="settings-item">
                    <span class="settings-label">Low voltage cutoff (V)</span>
                    <input type="number" class="settings-input" id="lowVoltage" value="60" step="0.1" onchange="saveSettings()">
                </div>
            </div>

            <!-- Battery 20s26p -->
            <div class="settings-section">
                <div class="settings-title">Battery (20s26p)</div>
                <div class="settings-item">
                    <span class="settings-label">Capacity (Ah)</span>
                    <input type="number" class="settings-input" id="battCapacity" value="130" onchange="saveSettings()">
                </div>
                <div class="settings-item">
                    <span class="settings-label">Full voltage (V)</span>
                    <input type="number" class="settings-input" id="battFull" value="84" step="0.1" onchange="saveSettings()">
                </div>
                <div class="settings-item">
                    <span class="settings-label">Empty voltage (V)</span>
                    <input type="number" class="settings-input" id="battEmpty" value="60" step="0.1" onchange="saveSettings()">
                </div>
            </div>

            <!-- Alarms -->
            <div class="settings-section">
                <div class="settings-title">Alarms</div>
                <div class="settings-item">
                    <span class="settings-label">Temp alarm</span>
                    <div class="toggle active" id="alarmTempToggle" onclick="toggleAlarmTemp()"></div>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Low battery alarm</span>
                    <div class="toggle active" id="alarmBatToggle" onclick="toggleAlarmBat()"></div>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Vibration</span>
                    <div class="toggle active" id="alarmVibToggle" onclick="toggleAlarmVib()"></div>
                </div>
            </div>

            <!-- Security -->
            <div class="settings-section">
                <div class="settings-title">Security</div>
                <div class="settings-item">
                    <span class="settings-label">PIN Lock</span>
                    <div class="toggle" id="lockToggle" onclick="toggleLock()"></div>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Change PIN</span>
                    <button class="settings-btn" onclick="changePin()">Set PIN</button>
                </div>
            </div>

            <!-- Trip -->
            <div class="settings-section">
                <div class="settings-title">Trip</div>
                <div class="settings-item">
                    <span class="settings-label">Reset trip</span>
                    <button class="settings-btn danger" onclick="resetTrip()">Reset</button>
                </div>
            </div>

            <!-- Info -->
            <!-- LED RGB Section -->
            <div class="settings-section">
                <div class="settings-title">LED RGB</div>
                <div class="settings-item">
                    <span class="settings-label">Mode</span>
                    <select class="settings-input" id="ledMode" onchange="setLedMode()" style="width:120px">
                        <option value="0">Off</option>
                        <option value="1">Solid</option>
                        <option value="2">Breathing</option>
                        <option value="3">Rainbow</option>
                        <option value="4">Gear</option>
                        <option value="5">Cadence</option>
                        <option value="6">Speed</option>
                        <option value="9">Strobe</option>
                        <option value="10">Candle</option>
                        <option value="11" selected>Gradient</option>
                    </select>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Brightness</span>
                    <input type="range" class="settings-input" id="ledBrightness" min="0" max="255" value="200"
                           style="width:100px" oninput="setLedBrightness()">
                </div>
                <div class="settings-item">
                    <span class="settings-label">Speed</span>
                    <input type="range" class="settings-input" id="ledSpeed" min="1" max="255" value="128"
                           style="width:100px" oninput="setLedSpeed()">
                </div>
                <div class="settings-item" id="ledSolidColorItem">
                    <span class="settings-label">Color</span>
                    <input type="color" class="settings-input" id="ledColor" value="#00ffff"
                           style="width:60px;height:30px;padding:0;border:none" onchange="setLedColor()">
                </div>

                <!-- Gradient Colors -->
                <div id="gradientSection">
                    <div class="settings-item" style="flex-direction:column;align-items:flex-start;gap:8px">
                        <span class="settings-label">Gradient Colors</span>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                            <input type="color" class="gradient-color" id="gradColor0" value="#ff0000" onchange="updateGradient()">
                            <input type="color" class="gradient-color" id="gradColor1" value="#00ff00" onchange="updateGradient()">
                            <input type="color" class="gradient-color" id="gradColor2" value="#0000ff" onchange="updateGradient()">
                            <input type="color" class="gradient-color" id="gradColor3" value="#ffff00" onchange="updateGradient()" style="display:none">
                            <input type="color" class="gradient-color" id="gradColor4" value="#ff00ff" onchange="updateGradient()" style="display:none">
                        </div>
                    </div>
                    <div class="settings-item">
                        <span class="settings-label">Colors count</span>
                        <input type="number" class="settings-input" id="gradientCount" min="2" max="5" value="3"
                               style="width:50px" onchange="updateGradientCount()">
                    </div>
                    <div class="settings-item">
                        <button class="settings-btn" onclick="applyGradient()">Apply Gradient</button>
                    </div>
                </div>

                <!-- Quick Presets -->
                <div class="settings-item" style="flex-direction:column;align-items:flex-start;gap:8px">
                    <span class="settings-label">Presets</span>
                    <div style="display:flex;gap:5px;flex-wrap:wrap">
                        <button class="led-preset-btn" onclick="ledPreset('fire')" style="background:linear-gradient(90deg,#ff0000,#ff8000,#ffff00)">Fire</button>
                        <button class="led-preset-btn" onclick="ledPreset('ocean')" style="background:linear-gradient(90deg,#0000ff,#00ffff,#00ff80)">Ocean</button>
                        <button class="led-preset-btn" onclick="ledPreset('sunset')" style="background:linear-gradient(90deg,#ff0080,#ff8000,#ffff00)">Sunset</button>
                        <button class="led-preset-btn" onclick="ledPreset('forest')" style="background:linear-gradient(90deg,#004400,#00ff00,#88ff00)">Forest</button>
                        <button class="led-preset-btn" onclick="ledPreset('neon')" style="background:linear-gradient(90deg,#ff00ff,#00ffff,#ff00ff)">Neon</button>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-title">Info</div>
                <div class="settings-item">
                    <span class="settings-label">mAh/km</span>
                    <span class="settings-value" id="mahPerKm">--</span>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Avg speed</span>
                    <span class="settings-value" id="avgSpeed">-- km/h</span>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Max speed</span>
                    <span class="settings-value" id="maxSpeedReached">-- km/h</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== STATE ====================
        let settings = {
            wheelCircum: 2200,
            wheelPulses: 1,
            gearCount: 8,
            gearPositions: [100, 200, 300, 400, 500, 600, 700, 800],
            gearSpeedThresholds: [0, 10, 18, 26, 34, 42, 50, 60],
            gearHysteresis: 3,
            // PAS
            pasEnabled: true,
            pasLevel: 5,
            pasMagnets: 12,
            // Throttle
            throttleEnabled: true,
            throttleCurve: 'linear',
            // Cruise
            cruiseEnabled: false,
            cruiseDelay: 3,
            // Braking
            adaptiveBrake: false,
            brakeMinBat: 20,
            regenLevel: 30,
            trailerBraking: false,
            // Power
            powerMode: 'normal',
            walkAssist: false,
            reverse: false,
            // Limits
            limitSpeed: 90,
            limitCurrent: 260,
            limitPhase: 400,
            limitTemp: 80,
            lowVoltage: 60,
            // Battery 20s26p
            battCapacity: 130,
            battFull: 84,
            battEmpty: 60,
            // Alarms
            alarmTemp: true,
            alarmBat: true,
            alarmVib: true,
            // Security
            lockEnabled: false,
            pin: '1234',
            // Trip
            totalDistance: 0,
            tripDistance: 0
        };

        let currentGear = 1;
        let bikeLocked = false;
        let isLocked = false;
        let gearAutoMode = false;
        let speedLimitEnabled = false;
        let savedSpeedLimit = 50;
        let pasOnlyMode = false;
        let previousSpeedLimit = 50;
        let previousSpeedLimitEnabled = false;

        // ==================== INIT ====================
        function init() {
            loadSettings();
            updateGearInputs();
            updateUI();
            updatePowerModeUI();
            updatePasUI();

            // Initialize slider
            document.getElementById('sliderFill').style.width = '50%';

            if (settings.lockEnabled) {
                showLockScreen();
            }
        }

        // ==================== SETTINGS ====================
        function loadSettings() {
            const saved = localStorage.getItem('ebikeSettings');
            if (saved) {
                settings = {...settings, ...JSON.parse(saved)};
            }
            applySettingsToUI();
        }

        function saveSettings() {
            // Wheel
            settings.wheelCircum = parseInt(document.getElementById('wheelCircum').value) || 2200;
            settings.wheelPulses = parseInt(document.getElementById('wheelPulses').value) || 1;
            // Gears
            settings.gearHysteresis = parseInt(document.getElementById('gearHysteresis').value) || 3;
            // PAS
            settings.pasLevel = parseInt(document.getElementById('pasLevel').value) || 5;
            settings.pasMagnets = parseInt(document.getElementById('pasMagnets').value) || 12;
            // Throttle
            settings.throttleCurve = document.getElementById('throttleCurve').value || 'linear';
            // Cruise
            settings.cruiseDelay = parseInt(document.getElementById('cruiseDelay').value) || 3;
            // Braking
            settings.brakeMinBat = parseInt(document.getElementById('brakeMinBat').value) || 20;
            settings.regenLevel = parseInt(document.getElementById('regenLevel').value) || 30;
            // Power
            settings.powerMode = document.getElementById('powerMode').value || 'normal';
            // Limits
            settings.limitSpeed = parseInt(document.getElementById('limitSpeed').value) || 90;
            settings.limitCurrent = parseInt(document.getElementById('limitCurrent').value) || 260;
            settings.limitPhase = parseInt(document.getElementById('limitPhase').value) || 400;
            settings.limitTemp = parseInt(document.getElementById('limitTemp').value) || 80;
            settings.lowVoltage = parseFloat(document.getElementById('lowVoltage').value) || 60;
            // Battery
            settings.battCapacity = parseInt(document.getElementById('battCapacity').value) || 130;
            settings.battFull = parseFloat(document.getElementById('battFull').value) || 84;
            settings.battEmpty = parseFloat(document.getElementById('battEmpty').value) || 60;

            localStorage.setItem('ebikeSettings', JSON.stringify(settings));
        }

        function applySettingsToUI() {
            // Wheel
            document.getElementById('wheelCircum').value = settings.wheelCircum;
            document.getElementById('wheelPulses').value = settings.wheelPulses;
            // Gears
            document.getElementById('gearCount').value = settings.gearCount;
            document.getElementById('gearHysteresis').value = settings.gearHysteresis;
            // PAS
            document.getElementById('pasLevel').value = settings.pasLevel;
            document.getElementById('pasMagnets').value = settings.pasMagnets;
            document.getElementById('pasToggle').classList.toggle('active', settings.pasEnabled);
            // Throttle
            document.getElementById('throttleToggle').classList.toggle('active', settings.throttleEnabled);
            document.getElementById('throttleCurve').value = settings.throttleCurve;
            // Cruise
            document.getElementById('cruiseToggle').classList.toggle('active', settings.cruiseEnabled);
            document.getElementById('cruiseDelay').value = settings.cruiseDelay;
            // Braking
            document.getElementById('adaptiveBrakeToggle').classList.toggle('active', settings.adaptiveBrake);
            document.getElementById('brakeMinBat').value = settings.brakeMinBat;
            document.getElementById('regenLevel').value = settings.regenLevel;
            document.getElementById('trailerToggle').classList.toggle('active', settings.trailerBraking);
            // Power
            document.getElementById('powerMode').value = settings.powerMode;
            document.getElementById('walkAssistToggle').classList.toggle('active', settings.walkAssist);
            document.getElementById('reverseToggle').classList.toggle('active', settings.reverse);
            // Limits
            document.getElementById('limitSpeed').value = settings.limitSpeed;
            document.getElementById('limitCurrent').value = settings.limitCurrent;
            document.getElementById('limitPhase').value = settings.limitPhase;
            document.getElementById('limitTemp').value = settings.limitTemp;
            document.getElementById('lowVoltage').value = settings.lowVoltage;
            // Battery
            document.getElementById('battCapacity').value = settings.battCapacity;
            document.getElementById('battFull').value = settings.battFull;
            document.getElementById('battEmpty').value = settings.battEmpty;
            // Alarms
            document.getElementById('alarmTempToggle').classList.toggle('active', settings.alarmTemp);
            document.getElementById('alarmBatToggle').classList.toggle('active', settings.alarmBat);
            document.getElementById('alarmVibToggle').classList.toggle('active', settings.alarmVib);
            // Security
            document.getElementById('lockToggle').classList.toggle('active', settings.lockEnabled);
            // Trip
            document.getElementById('totalDistance').textContent = settings.totalDistance + ' km';
            document.getElementById('tripDistance').textContent = settings.tripDistance.toFixed(1) + ' km';
        }

        // ==================== GEARS ====================
        function updateGearInputs() {
            const count = parseInt(document.getElementById('gearCount').value) || 8;
            settings.gearCount = Math.min(8, Math.max(1, count));

            // Gear positions (encoder)
            const container = document.getElementById('gearPositions');
            container.innerHTML = '';

            for (let i = 0; i < settings.gearCount; i++) {
                const div = document.createElement('div');
                div.className = 'settings-item';
                div.innerHTML = `
                    <span class="settings-label">Gear ${i + 1} pos</span>
                    <input type="number" class="settings-input" id="gearPos${i}"
                           value="${settings.gearPositions[i] || (i + 1) * 100}"
                           onchange="updateGearPosition(${i})">
                `;
                container.appendChild(div);
            }

            // Auto gear speed thresholds
            const thresholdsContainer = document.getElementById('gearSpeedThresholds');
            if (thresholdsContainer) {
                thresholdsContainer.innerHTML = '';

                for (let i = 0; i < settings.gearCount; i++) {
                    const div = document.createElement('div');
                    div.className = 'settings-item';
                    div.innerHTML = `
                        <span class="settings-label">Gear ${i + 1} od (km/h)</span>
                        <input type="number" class="settings-input" id="gearSpeed${i}"
                               value="${settings.gearSpeedThresholds[i] || i * 10}"
                               onchange="updateGearSpeedThreshold(${i})">
                    `;
                    thresholdsContainer.appendChild(div);
                }
            }

            saveSettings();
        }

        function updateGearPosition(index) {
            settings.gearPositions[index] = parseInt(document.getElementById(`gearPos${index}`).value) || 0;
            saveSettings();
        }

        function updateGearSpeedThreshold(index) {
            settings.gearSpeedThresholds[index] = parseInt(document.getElementById(`gearSpeed${index}`).value) || 0;
            saveSettings();
        }

        function gearUp() {
            if (currentGear < settings.gearCount) {
                currentGear++;
                document.getElementById('gearNumber').textContent = currentGear;
                sendGearChange(currentGear);
            }
        }

        function gearDown() {
            if (currentGear > 1) {
                currentGear--;
                document.getElementById('gearNumber').textContent = currentGear;
                sendGearChange(currentGear);
            }
        }

        function toggleGearMode() {
            gearAutoMode = !gearAutoMode;
            const btn = document.getElementById('gearMode');
            if (gearAutoMode) {
                btn.textContent = 'auto';
                btn.classList.add('auto');
            } else {
                btn.textContent = 'manual';
                btn.classList.remove('auto');
            }
            // TODO: Send mode to nRF52
        }

        let lastAutoGearChange = 0;
        function checkAutoGear(speed) {
            if (!gearAutoMode) return;

            const now = Date.now();
            if (now - lastAutoGearChange < 500) return; // Debounce

            const hysteresis = settings.gearHysteresis || 3;
            let targetGear = 1;

            // Find the right gear for current speed
            for (let i = settings.gearCount - 1; i >= 0; i--) {
                const threshold = settings.gearSpeedThresholds[i] || 0;
                if (speed >= threshold) {
                    targetGear = i + 1;
                    break;
                }
            }

            // Apply hysteresis - only downshift if below threshold minus hysteresis
            if (targetGear < currentGear) {
                const currentThreshold = settings.gearSpeedThresholds[currentGear - 1] || 0;
                if (speed > currentThreshold - hysteresis) {
                    return; // Don't downshift yet
                }
            }

            if (targetGear !== currentGear) {
                currentGear = targetGear;
                document.getElementById('gearNumber').textContent = currentGear;
                sendGearChange(currentGear);
                lastAutoGearChange = now;

                if (settings.alarmVib && navigator.vibrate) {
                    navigator.vibrate(30);
                }
            }
        }

        function calibrateGear() {
            alert('Move gear to desired position, then click OK');
            // TODO: Read encoder value and save for current gear
        }

        function finetuneGear() {
            alert('Fine-tune mode: use +/- buttons to adjust');
            // TODO: Implement finetune mode
        }

        // ==================== TOGGLES ====================
        function togglePas() {
            settings.pasEnabled = !settings.pasEnabled;
            document.getElementById('pasToggle').classList.toggle('active', settings.pasEnabled);
            saveSettings();
        }

        function toggleThrottle() {
            settings.throttleEnabled = !settings.throttleEnabled;
            document.getElementById('throttleToggle').classList.toggle('active', settings.throttleEnabled);
            saveSettings();
        }

        function toggleCruise() {
            settings.cruiseEnabled = !settings.cruiseEnabled;
            document.getElementById('cruiseToggle').classList.toggle('active', settings.cruiseEnabled);
            saveSettings();
        }

        function toggleAdaptiveBrake() {
            settings.adaptiveBrake = !settings.adaptiveBrake;
            document.getElementById('adaptiveBrakeToggle').classList.toggle('active', settings.adaptiveBrake);
            saveSettings();
        }

        function toggleTrailer() {
            settings.trailerBraking = !settings.trailerBraking;
            document.getElementById('trailerToggle').classList.toggle('active', settings.trailerBraking);
            saveSettings();
        }

        function toggleWalkAssist() {
            settings.walkAssist = !settings.walkAssist;
            document.getElementById('walkAssistToggle').classList.toggle('active', settings.walkAssist);
            saveSettings();
        }

        function toggleReverse() {
            settings.reverse = !settings.reverse;
            document.getElementById('reverseToggle').classList.toggle('active', settings.reverse);
            saveSettings();
        }

        const powerModes = ['off', 'eco', 'normal', 'sport', 'turbo'];
        function cyclePowerMode() {
            const currentMode = settings.powerMode;
            const currentIndex = powerModes.indexOf(currentMode);
            const nextIndex = (currentIndex + 1) % powerModes.length;
            const wasInOffMode = (currentMode === 'off');

            // Save previous state before entering OFF
            if (powerModes[nextIndex] === 'off' && currentMode !== 'off') {
                previousSpeedLimit = savedSpeedLimit;
                previousSpeedLimitEnabled = speedLimitEnabled;
            }

            settings.powerMode = powerModes[nextIndex];

            applyPowerMode(wasInOffMode);
            updatePowerModeUI();
            document.getElementById('powerMode').value = settings.powerMode;
            saveSettings();

            if (settings.alarmVib && navigator.vibrate) {
                navigator.vibrate(30);
            }
        }

        function applyPowerMode(leavingOffMode = false) {
            if (settings.powerMode === 'off') {
                // OFF mode: PAS off, throttle on, max 20 km/h
                settings.pasEnabled = false;
                settings.throttleEnabled = true;
                document.getElementById('pasToggle').classList.remove('active');
                document.getElementById('throttleToggle').classList.add('active');
                pasOnlyMode = false;
                document.getElementById('pasOnlyBtn').classList.remove('active');
                document.getElementById('pasOnlyText').textContent = 'PAS+T';
                // Set speed limit to 20 km/h
                speedLimitEnabled = true;
                savedSpeedLimit = 20;
                document.getElementById('speedLimitBtn').classList.add('active');
                document.getElementById('maxSpeedSlider').value = 20;
                document.getElementById('sliderFill').style.width = '20%';
                document.getElementById('maxSpeedValue').innerHTML = '<span>20</span> km/h';
                if (ebikeService) sendMaxSpeed(20);
            } else if (leavingOffMode) {
                // Restore previous speed limit only when leaving OFF mode
                speedLimitEnabled = previousSpeedLimitEnabled;
                savedSpeedLimit = previousSpeedLimit;

                if (speedLimitEnabled) {
                    document.getElementById('speedLimitBtn').classList.add('active');
                    if (ebikeService) sendMaxSpeed(savedSpeedLimit);
                } else {
                    document.getElementById('speedLimitBtn').classList.remove('active');
                    if (ebikeService) sendMaxSpeed(0);
                }

                document.getElementById('maxSpeedSlider').value = savedSpeedLimit;
                document.getElementById('sliderFill').style.width = savedSpeedLimit + '%';
                document.getElementById('maxSpeedValue').innerHTML = '<span>' + savedSpeedLimit + '</span> km/h';
            }
        }

        function setPanicMode() {
            // Called from handlebar panic button via BLE
            // Save current state first
            if (settings.powerMode !== 'off') {
                previousSpeedLimit = savedSpeedLimit;
                previousSpeedLimitEnabled = speedLimitEnabled;
            }

            settings.powerMode = 'off';
            applyPowerMode(false); // entering OFF, not leaving
            updatePowerModeUI();
            document.getElementById('powerMode').value = 'off';
            saveSettings();

            if (settings.alarmVib && navigator.vibrate) {
                navigator.vibrate([100, 50, 100, 50, 100]);
            }
        }

        function updatePowerModeUI() {
            const btn = document.getElementById('powerModeBtn');
            const text = document.getElementById('powerModeText');

            btn.classList.remove('off', 'eco', 'normal', 'sport', 'turbo');
            btn.classList.add(settings.powerMode);
            text.textContent = settings.powerMode;
        }

        function cyclePasLevel() {
            settings.pasLevel = (settings.pasLevel % 10) + 1;
            document.getElementById('pasLevelValue').textContent = settings.pasLevel;
            document.getElementById('pasLevel').value = settings.pasLevel;
            saveSettings();

            if (settings.alarmVib && navigator.vibrate) {
                navigator.vibrate(20);
            }
            // TODO: Send PAS level to STM32
        }

        function togglePasOnly() {
            pasOnlyMode = !pasOnlyMode;
            const btn = document.getElementById('pasOnlyBtn');
            const text = document.getElementById('pasOnlyText');

            if (pasOnlyMode) {
                btn.classList.add('active');
                text.textContent = 'PAS';
                // Disable throttle
                settings.throttleEnabled = false;
                document.getElementById('throttleToggle').classList.remove('active');
            } else {
                btn.classList.remove('active');
                text.textContent = 'PAS+T';
                // Enable throttle
                settings.throttleEnabled = true;
                document.getElementById('throttleToggle').classList.add('active');
            }
            saveSettings();

            if (settings.alarmVib && navigator.vibrate) {
                navigator.vibrate(30);
            }
        }

        function updatePasUI() {
            document.getElementById('pasLevelValue').textContent = settings.pasLevel;
            if (!settings.throttleEnabled) {
                pasOnlyMode = true;
                document.getElementById('pasOnlyBtn').classList.add('active');
                document.getElementById('pasOnlyText').textContent = 'PAS';
            }
        }

        function toggleAlarmTemp() {
            settings.alarmTemp = !settings.alarmTemp;
            document.getElementById('alarmTempToggle').classList.toggle('active', settings.alarmTemp);
            saveSettings();
        }

        function toggleAlarmBat() {
            settings.alarmBat = !settings.alarmBat;
            document.getElementById('alarmBatToggle').classList.toggle('active', settings.alarmBat);
            saveSettings();
        }

        function toggleAlarmVib() {
            settings.alarmVib = !settings.alarmVib;
            document.getElementById('alarmVibToggle').classList.toggle('active', settings.alarmVib);
            saveSettings();
        }

        function toggleLock() {
            settings.lockEnabled = !settings.lockEnabled;
            document.getElementById('lockToggle').classList.toggle('active', settings.lockEnabled);
            saveSettings();
        }

        // ==================== BIKE LOCK ====================
        async function toggleBikeLock() {
            if (bikeLocked) {
                // Need to unlock - show PIN prompt
                showUnlockPrompt();
            } else {
                // Lock the bike
                await sendLockCommand(true);
            }
        }

        async function sendLockCommand(lock, pin = '') {
            const btn = document.getElementById('lockBtn');
            const text = document.getElementById('lockText');

            if (ebikeService) {
                try {
                    const characteristic = await ebikeService.getCharacteristic(LOCK_CHAR_UUID);
                    let data;
                    if (lock) {
                        data = new Uint8Array([1]); // 1 = lock
                    } else {
                        // 0 = unlock, followed by PIN
                        const encoder = new TextEncoder();
                        const pinBytes = encoder.encode(pin);
                        data = new Uint8Array(1 + pinBytes.length);
                        data[0] = 0;
                        data.set(pinBytes, 1);
                    }
                    await characteristic.writeValue(data);

                    bikeLocked = lock;
                    if (bikeLocked) {
                        btn.classList.add('locked');
                        text.textContent = 'locked';
                        if (settings.alarmVib && navigator.vibrate) {
                            navigator.vibrate([50, 30, 50]);
                        }
                    } else {
                        btn.classList.remove('locked');
                        text.textContent = 'unlock';
                        if (settings.alarmVib && navigator.vibrate) {
                            navigator.vibrate(50);
                        }
                    }
                    return true;
                } catch (error) {
                    console.error('Lock command failed:', error);
                    if (settings.alarmVib && navigator.vibrate) {
                        navigator.vibrate([100, 50, 100, 50, 100]);
                    }
                    return false;
                }
            } else {
                // No BLE - use local state only
                bikeLocked = lock;
                if (bikeLocked) {
                    btn.classList.add('locked');
                    text.textContent = 'locked';
                } else {
                    btn.classList.remove('locked');
                    text.textContent = 'unlock';
                }
                return true;
            }
        }

        function showUnlockPrompt() {
            const pin = prompt('Enter PIN to unlock:');
            if (pin) {
                sendLockCommand(false, pin);
            }
        }

        async function changePinViaBLE(oldPin, newPin) {
            if (!ebikeService) {
                console.log('BLE not connected');
                return false;
            }
            try {
                const characteristic = await ebikeService.getCharacteristic(PIN_CHAR_UUID);
                const encoder = new TextEncoder();
                const oldPinBytes = encoder.encode(oldPin);
                const newPinBytes = encoder.encode(newPin);
                const data = new Uint8Array(oldPinBytes.length + newPinBytes.length);
                data.set(oldPinBytes, 0);
                data.set(newPinBytes, oldPinBytes.length);
                await characteristic.writeValue(data);
                console.log('PIN changed successfully');
                return true;
            } catch (error) {
                console.error('PIN change failed:', error);
                return false;
            }
        }

        async function readLockState() {
            if (!ebikeService) return;
            try {
                const characteristic = await ebikeService.getCharacteristic(LOCK_CHAR_UUID);
                const value = await characteristic.readValue();
                bikeLocked = value.getUint8(0) === 1;
                const btn = document.getElementById('lockBtn');
                const text = document.getElementById('lockText');
                if (bikeLocked) {
                    btn.classList.add('locked');
                    text.textContent = 'locked';
                } else {
                    btn.classList.remove('locked');
                    text.textContent = 'unlock';
                }
            } catch (error) {
                console.error('Failed to read lock state:', error);
            }
        }

        // ==================== LOCK SCREEN ====================
        let enteredPin = '';

        function showLockScreen() {
            isLocked = true;
            document.getElementById('lockScreen').classList.add('active');
            enteredPin = '';
            updatePinDisplay();
        }

        function hideLockScreen() {
            isLocked = false;
            document.getElementById('lockScreen').classList.remove('active');
        }

        function enterPin(num) {
            if (enteredPin.length < 4) {
                enteredPin += num;
                updatePinDisplay();
            }
        }

        function clearPin() {
            enteredPin = '';
            updatePinDisplay();
        }

        function submitPin() {
            if (enteredPin === settings.pin) {
                hideLockScreen();
                if (settings.alarmVib && navigator.vibrate) {
                    navigator.vibrate(100);
                }
            } else {
                enteredPin = '';
                updatePinDisplay();
                if (settings.alarmVib && navigator.vibrate) {
                    navigator.vibrate([100, 50, 100, 50, 100]);
                }
            }
        }

        function updatePinDisplay() {
            document.getElementById('pinDisplay').textContent = 'â—'.repeat(enteredPin.length);
        }

        async function changePin() {
            const oldPin = prompt('Enter current PIN:');
            if (!oldPin) return;

            const newPin = prompt('Enter new PIN (4-8 digits):');
            if (!newPin || newPin.length < 4 || newPin.length > 8 || !/^\d+$/.test(newPin)) {
                alert('PIN must be 4-8 digits');
                return;
            }

            const confirmPin = prompt('Confirm new PIN:');
            if (newPin !== confirmPin) {
                alert('PINs do not match');
                return;
            }

            if (ebikeService) {
                const success = await changePinViaBLE(oldPin, newPin);
                if (success) {
                    settings.pin = newPin;
                    saveSettings();
                    alert('PIN changed on device!');
                } else {
                    alert('Failed to change PIN. Check old PIN.');
                }
            } else {
                // No BLE - just save locally
                settings.pin = newPin;
                saveSettings();
                alert('PIN changed locally (connect to sync with device)');
            }
        }

        // ==================== TRIP ====================
        function resetTrip() {
            if (confirm('Reset trip distance?')) {
                settings.tripDistance = 0;
                document.getElementById('tripDistance').textContent = '0 km';
                saveSettings();
            }
        }

        // ==================== SPEED LIMIT ====================
        function toggleSpeedLimit() {
            speedLimitEnabled = !speedLimitEnabled;
            const btn = document.getElementById('speedLimitBtn');

            if (speedLimitEnabled) {
                btn.classList.add('active');
                // Apply the saved speed limit
                if (ebikeService && !bikeLocked) {
                    sendMaxSpeed(savedSpeedLimit);
                }
                if (settings.alarmVib && navigator.vibrate) {
                    navigator.vibrate([50, 30, 50]);
                }
            } else {
                btn.classList.remove('active');
                // Remove speed limit
                if (ebikeService && !bikeLocked) {
                    sendMaxSpeed(0);
                }
                if (settings.alarmVib && navigator.vibrate) {
                    navigator.vibrate(50);
                }
            }
        }

        function updateMaxSpeed(value) {
            const fill = document.getElementById('sliderFill');
            const label = document.getElementById('maxSpeedValue');

            fill.style.width = value + '%';
            savedSpeedLimit = parseInt(value);
            label.innerHTML = '<span>' + value + '</span> km/h';

            // Only send if limit is enabled
            if (speedLimitEnabled && ebikeService && !bikeLocked) {
                sendMaxSpeed(savedSpeedLimit);
            }
        }

        // ==================== NAVIGATION ====================
        function openNav() {
            document.getElementById('mySidenav').style.width = '300px';
            document.getElementById('mySidenav').classList.add('open');
        }

        function closeNav() {
            document.getElementById('mySidenav').style.width = '0';
            document.getElementById('mySidenav').classList.remove('open');
        }

        // ==================== UI UPDATES ====================
        const circleSpeed = document.querySelector('.SPEED-circle');
        const circleBatt = document.querySelector('.BATT-circle');
        const circleSpeedLength = 2 * Math.PI * 50;
        const circleBattLength = 2 * Math.PI * 45;

        function updateUI() {
            // Update distances
            document.getElementById('totalDistance').textContent = settings.totalDistance + ' km';
            document.getElementById('tripDistance').textContent = settings.tripDistance.toFixed(1) + ' km';
        }

        function updateSPEED(value) {
            // Rotacja zaczyna siÄ™ od 45 stopni, wiÄ™c offset idzie w drugÄ… stronÄ™
            let offset = -circleSpeedLength * (1 - value / 100);
            circleSpeed.style.strokeDashoffset = offset;
            document.getElementById('progressSPEED').textContent = value;
        }

        function updateCURRENT(value) {
            document.getElementById('progressCURRENT').textContent = value + ' A';
        }

        function updateBATPRO(percent) {
            // Rotacja zaczyna siÄ™ od 45 stopni
            let offset = -circleBattLength * (1 - percent / 100);
            circleBatt.style.strokeDashoffset = offset;
            document.getElementById('progressBATPRO').textContent = percent + '%';

            // Color based on level
            let color = '#4caf50';
            if (percent < 20) color = '#ff4444';
            else if (percent < 40) color = '#ff8800';
            circleBatt.style.stroke = color;
            document.getElementById('progressBATPRO').style.fill = color;

            // Alarm
            if (percent < 15 && settings.alarmBat) {
                triggerAlarm('Low battery!');
            }
        }

        function updateTEMPBAT(index, value) {
            const progM = document.getElementById('battempprogres' + index);
            const progD = document.getElementById('battempprogres' + index + 'd');
            const valM = document.getElementById('battemp' + index);
            const valD = document.getElementById('battemp' + index + 'd');

            const height = Math.min(value * 1.5, 100) + '%';
            let color = 'white';
            if (value > 50) color = '#ff4444';
            else if (value > 40) color = '#ff8800';

            if (progM) {
                progM.style.height = height;
                progM.style.backgroundColor = color;
            }
            if (progD) {
                progD.style.height = height;
                progD.style.backgroundColor = color;
            }
            if (valM) valM.textContent = value + 'Â°c';
            if (valD) valD.textContent = value + 'Â°c';
        }

        function triggerAlarm(message) {
            if (settings.alarmVib && navigator.vibrate) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }
            console.log('ALARM:', message);
        }

        // ==================== WEB BLUETOOTH ====================
        const EBIKE_SERVICE_UUID = '12345678-1234-5678-1234-56789abcdef0';
        const SPEED_CHAR_UUID = '12345678-1234-5678-1234-56789abcdef1';
        const CURRENT_CHAR_UUID = '12345678-1234-5678-1234-56789abcdef2';
        const BATTERY_CHAR_UUID = '12345678-1234-5678-1234-56789abcdef3';
        const TEMPS_CHAR_UUID = '12345678-1234-5678-1234-56789abcdef4';
        const MAXSPEED_CHAR_UUID = '12345678-1234-5678-1234-56789abcdef5';
        const PIN_CHAR_UUID = '12345678-1234-5678-1234-56789abcdef6';
        const LOCK_CHAR_UUID = '12345678-1234-5678-1234-56789abcdef7';

        let bleDevice = null;
        let bleServer = null;
        let ebikeService = null;

        // Properly disconnect before page unload
        window.addEventListener('beforeunload', () => {
            if (bleServer && bleServer.connected) {
                bleServer.disconnect();
            }
        });

        let isConnecting = false;

        async function connectBLE() {
            // Prevent double-clicks
            if (isConnecting) return;

            try {
                // If already connected, disconnect and wait
                if (bleServer && bleServer.connected) {
                    console.log('Disconnecting...');
                    updateBLEStatus('disconnected');
                    bleServer.disconnect();
                    cleanupBLE();
                    // Wait for nRF to restart advertising
                    await new Promise(r => setTimeout(r, 1500));
                    return;
                }

                isConnecting = true;
                updateBLEStatus('connecting');

                // Always request a new device
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [
                        { name: 'Ebike' },
                        { namePrefix: 'Ebike' }
                    ],
                    optionalServices: [EBIKE_SERVICE_UUID]
                });

                bleDevice.addEventListener('gattserverdisconnected', onDisconnected);

                // Try to connect with retry
                let retries = 3;
                while (retries > 0) {
                    try {
                        bleServer = await bleDevice.gatt.connect();
                        break;
                    } catch (e) {
                        retries--;
                        if (retries === 0) throw e;
                        console.log('Retrying connection...');
                        await new Promise(r => setTimeout(r, 500));
                    }
                }

                ebikeService = await bleServer.getPrimaryService(EBIKE_SERVICE_UUID);

                await subscribeToCharacteristic(SPEED_CHAR_UUID, handleSpeed);
                await subscribeToCharacteristic(CURRENT_CHAR_UUID, handleCurrent);
                await subscribeToCharacteristic(BATTERY_CHAR_UUID, handleBattery);
                await subscribeToCharacteristic(TEMPS_CHAR_UUID, handleTemps);

                // Read initial lock state from MCU
                await readLockState();

                // Initialize LED characteristic
                try {
                    ledCharacteristic = await ebikeService.getCharacteristic(LED_CHAR_UUID);
                    console.log('LED characteristic ready');
                    // Apply saved LED settings after connection
                    setTimeout(() => applyGradient(), 500);
                } catch (e) {
                    console.log('LED characteristic not available:', e);
                }

                updateBLEStatus('connected');
                console.log('BLE connected successfully');

            } catch (error) {
                console.error('BLE Error:', error);
                updateBLEStatus('disconnected');
                cleanupBLE();
            } finally {
                isConnecting = false;
            }
        }

        function disconnectBLE() {
            console.log('disconnectBLE called');
            if (bleServer) {
                try {
                    if (bleServer.connected) {
                        bleServer.disconnect();
                    }
                } catch (e) {
                    console.log('Disconnect error (ignored):', e);
                }
            }
            cleanupBLE();
            updateBLEStatus('disconnected');
        }

        function cleanupBLE() {
            ebikeService = null;
            bleServer = null;
            ledCharacteristic = null;
            bleDevice = null;  // Clear device - always request fresh
        }

        async function subscribeToCharacteristic(uuid, handler) {
            const characteristic = await ebikeService.getCharacteristic(uuid);
            await characteristic.startNotifications();
            characteristic.addEventListener('characteristicvaluechanged', handler);
        }

        function onDisconnected(event) {
            console.log('BLE disconnected event', event);
            isConnecting = false;
            updateBLEStatus('disconnected');
            cleanupBLE();
        }

        function updateBLEStatus(status) {
            const dot = document.getElementById('bleDot');
            const text = document.getElementById('bleStatus');
            const menuText = document.getElementById('bleStatusMenu');
            const bleButton = document.getElementById('bleButton');
            const bleButtonText = document.getElementById('bleButtonText');

            if (status === 'connected') {
                if (dot) dot.classList.remove('disconnected');
                if (text) {
                    text.textContent = 'Connected';
                    text.classList.add('connected');
                }
                if (menuText) menuText.textContent = 'Connected';
                if (bleButton) bleButton.classList.add('connected');
                if (bleButtonText) bleButtonText.textContent = 'Connected';
            } else if (status === 'connecting') {
                if (text) text.textContent = 'Connecting...';
                if (menuText) menuText.textContent = 'Connecting...';
                if (bleButtonText) bleButtonText.textContent = 'Connecting...';
            } else {
                if (dot) dot.classList.add('disconnected');
                if (text) {
                    text.textContent = 'Connect';
                    text.classList.remove('connected');
                }
                if (menuText) menuText.textContent = 'Disconnected';
                if (bleButton) bleButton.classList.remove('connected');
                if (bleButtonText) bleButtonText.textContent = 'BLE';
            }
        }

        function handleSpeed(event) {
            const value = event.target.value.getUint8(0);
            updateSPEED(value);
            checkAutoGear(value);

            // Check alarm
            if (value > settings.limitSpeed && settings.alarmTemp) {
                triggerAlarm('Speed limit exceeded!');
            }
        }

        function handleCurrent(event) {
            const value = event.target.value.getUint16(0, true) / 100;
            updateCURRENT(value.toFixed(2));

            if (value > settings.limitCurrent && settings.alarmTemp) {
                triggerAlarm('Current limit exceeded!');
            }
        }

        function handleBattery(event) {
            const voltage = event.target.value.getUint16(0, true) / 100;
            const percent = event.target.value.getUint8(2);
            updateBATPRO(percent);
            document.getElementById('progressBAT').textContent = voltage.toFixed(1) + 'v';
        }

        function handleTemps(event) {
            const data = event.target.value;
            const tempEngine = data.getInt8(0);
            const tempController = data.getInt8(1);
            const tempOutdoor = data.getInt8(2);
            const tempBat1 = data.getInt8(3);
            const tempBat2 = data.getInt8(4);
            const tempBat3 = data.getInt8(5);
            const tempBat4 = data.byteLength > 6 ? data.getInt8(6) : 0;

            document.getElementById('tempENGINE').textContent = tempEngine + 'Â°c';
            document.getElementById('tempCONTROLLER').textContent = tempController + 'Â°c';
            document.getElementById('tempOUTDOR').textContent = tempOutdoor + 'Â°c';

            updateTEMPBAT(1, tempBat1);
            updateTEMPBAT(2, tempBat2);
            updateTEMPBAT(3, tempBat3);
            updateTEMPBAT(4, tempBat4);

            // Check temp alarms
            const maxTemp = Math.max(tempEngine, tempController, tempBat1, tempBat2, tempBat3, tempBat4);
            if (maxTemp > settings.limitTemp && settings.alarmTemp) {
                triggerAlarm('Temperature limit exceeded!');
            }
        }

        async function sendMaxSpeed(value) {
            if (!ebikeService) return;
            try {
                const characteristic = await ebikeService.getCharacteristic(MAXSPEED_CHAR_UUID);
                await characteristic.writeValue(new Uint8Array([value]));
            } catch (error) {
                console.error('Error sending max speed:', error);
            }
        }

        async function sendGearChange(gear) {
            // TODO: Send gear to nRF52
            console.log('Gear changed to:', gear);
        }

        // ==================== FULLSCREEN ====================
        function toggleFullscreen() {
            const btn = document.getElementById('fullscreenBtn');

            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                // Enter fullscreen
                const elem = document.documentElement;
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.mozRequestFullScreen) {
                    elem.mozRequestFullScreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
                btn.classList.add('active');
                btn.textContent = 'â›¶';
            } else {
                // Exit fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                btn.classList.remove('active');
            }
        }

        // Listen for fullscreen change
        document.addEventListener('fullscreenchange', updateFullscreenBtn);
        document.addEventListener('webkitfullscreenchange', updateFullscreenBtn);

        function updateFullscreenBtn() {
            const btn = document.getElementById('fullscreenBtn');
            if (document.fullscreenElement || document.webkitFullscreenElement) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        }

        // ==================== SIMULATION ====================
        let simTemps = [25, 26, 24, 27];
        let simSpeed = 0;
        let simCurrent = 0;
        let simBattery = 85;
        let simEngineTemp = 30;
        let simControllerTemp = 28;
        let simOutdoorTemp = 22;
        let simDistance = 0;
        let simTotalWh = 0;
        let simVoltage = 72;

        function runSimulation() {
            setInterval(() => {
                // Simulate battery temps slowly rising/falling
                for (let i = 0; i < 4; i++) {
                    simTemps[i] += (Math.random() - 0.4) * 2;
                    simTemps[i] = Math.max(15, Math.min(65, simTemps[i]));
                    updateTEMPBAT(i + 1, Math.round(simTemps[i]));
                }

                // Simulate speed
                simSpeed += (Math.random() - 0.3) * 5;
                simSpeed = Math.max(0, Math.min(99, simSpeed));
                updateSPEED(Math.round(simSpeed));
                checkAutoGear(Math.round(simSpeed));

                // Simulate current
                simCurrent = simSpeed * 0.15 + Math.random() * 2;
                updateCURRENT(simCurrent.toFixed(2));

                // Simulate battery drain
                if (simSpeed > 5) simBattery -= 0.02;
                simBattery = Math.max(0, Math.min(100, simBattery));
                updateBATPRO(Math.round(simBattery));
                document.getElementById('progressBAT').textContent = (48 + simBattery * 0.24).toFixed(1) + 'v';

                // Simulate distance and consumption
                if (simSpeed > 0) {
                    simDistance += simSpeed / 3600 * 0.5; // km per 0.5s
                    simTotalWh += (simVoltage * simCurrent) / 3600 * 0.5; // Wh per 0.5s
                }

                // Calculate and display avg consumption
                if (simDistance > 0.1) {
                    const avgConsumption = simTotalWh / simDistance;
                    document.getElementById('avgConsumption').textContent = avgConsumption.toFixed(1);
                }

                // Simulate other temps
                simEngineTemp += (Math.random() - 0.45) * 1;
                simControllerTemp += (Math.random() - 0.45) * 0.8;
                simEngineTemp = Math.max(25, Math.min(80, simEngineTemp));
                simControllerTemp = Math.max(25, Math.min(70, simControllerTemp));

                document.getElementById('tempENGINE').textContent = Math.round(simEngineTemp) + 'Â°c';
                document.getElementById('tempCONTROLLER').textContent = Math.round(simControllerTemp) + 'Â°c';
                document.getElementById('tempOUTDOR').textContent = Math.round(simOutdoorTemp) + 'Â°c';

            }, 500);
        }

        // ==================== LED RGB CONTROL ====================

        // LED Command IDs (matching STM32 protocol)
        const CMD_LED_SET_MODE = 17;
        const CMD_LED_SET_COLOR = 18;
        const CMD_LED_SET_BRIGHTNESS = 19;
        const CMD_LED_SET_SPEED = 20;
        const CMD_LED_OFF = 21;
        const CMD_LED_GRADIENT_SET_COLOR = 22;
        const CMD_LED_GRADIENT_SET_COUNT = 23;
        const CMD_LED_GRADIENT_CLEAR = 24;

        // LED characteristic UUID (add to your nRF service)
        const LED_CHAR_UUID = '12345678-1234-5678-1234-56789abcdef8';

        let ledCharacteristic = null;

        // Send LED command via BLE
        async function sendLedCommand(command, param1 = 0, param2 = 0, param3 = 0) {
            if (!ebikeService) {
                console.log('BLE not connected, LED command:', command, param1, param2, param3);
                return;
            }

            try {
                if (!ledCharacteristic) {
                    ledCharacteristic = await ebikeService.getCharacteristic(LED_CHAR_UUID);
                }

                // Build command packet (simplified - adjust to match your protocol)
                const buffer = new ArrayBuffer(16);
                const view = new DataView(buffer);
                view.setUint8(0, command);
                view.setUint8(1, param1);
                view.setInt16(2, param2, true);  // little endian
                view.setInt32(4, param3, true);  // little endian

                await ledCharacteristic.writeValue(buffer);
                console.log('LED command sent:', command, param1, param2, param3);
            } catch (error) {
                console.error('LED command error:', error);
            }
        }

        // Set LED mode
        function setLedMode() {
            const mode = parseInt(document.getElementById('ledMode').value);
            sendLedCommand(CMD_LED_SET_MODE, mode);

            // Show/hide gradient section based on mode
            const gradientSection = document.getElementById('gradientSection');
            const solidColorItem = document.getElementById('ledSolidColorItem');

            if (mode === 11) { // Gradient mode
                gradientSection.style.display = 'block';
                solidColorItem.style.display = 'none';
            } else if (mode === 1 || mode === 2 || mode === 9) { // Solid, Breathing, Strobe
                gradientSection.style.display = 'none';
                solidColorItem.style.display = 'flex';
            } else {
                gradientSection.style.display = 'none';
                solidColorItem.style.display = 'none';
            }

            updateLedButtonText();
            saveLedSettings();
        }

        // Set LED color (for solid mode)
        function setLedColor() {
            const colorHex = document.getElementById('ledColor').value;
            const color = parseInt(colorHex.substring(1), 16);
            sendLedCommand(CMD_LED_SET_COLOR, 0, 0, color);
            saveLedSettings();
        }

        // Set LED brightness
        function setLedBrightness() {
            const brightness = parseInt(document.getElementById('ledBrightness').value);
            sendLedCommand(CMD_LED_SET_BRIGHTNESS, brightness);
            saveLedSettings();
        }

        // Set LED effect speed
        function setLedSpeed() {
            const speed = parseInt(document.getElementById('ledSpeed').value);
            sendLedCommand(CMD_LED_SET_SPEED, speed);
            saveLedSettings();
        }

        // Update gradient color count display
        function updateGradientCount() {
            const count = parseInt(document.getElementById('gradientCount').value);
            for (let i = 0; i < 5; i++) {
                const colorInput = document.getElementById('gradColor' + i);
                colorInput.style.display = (i < count) ? 'block' : 'none';
            }
            saveLedSettings();
        }

        // Update gradient (called on color change)
        function updateGradient() {
            saveLedSettings();
        }

        // Apply gradient to LED
        function applyGradient() {
            const count = parseInt(document.getElementById('gradientCount').value);

            // Clear existing gradient
            sendLedCommand(CMD_LED_GRADIENT_CLEAR);

            // Small delay between commands
            setTimeout(() => {
                // Set each color
                for (let i = 0; i < count; i++) {
                    const colorHex = document.getElementById('gradColor' + i).value;
                    const color = parseInt(colorHex.substring(1), 16);

                    setTimeout(() => {
                        sendLedCommand(CMD_LED_GRADIENT_SET_COLOR, i, 0, color);
                    }, i * 50);
                }

                // Set count and mode after colors are set
                setTimeout(() => {
                    sendLedCommand(CMD_LED_GRADIENT_SET_COUNT, count);
                    setTimeout(() => {
                        document.getElementById('ledMode').value = '11';
                        sendLedCommand(CMD_LED_SET_MODE, 11);
                    }, 50);
                }, count * 50 + 100);
            }, 50);

            saveLedSettings();
        }

        // LED Presets
        function ledPreset(preset) {
            const presets = {
                fire: ['#ff0000', '#ff8000', '#ffff00'],
                ocean: ['#0000ff', '#00ffff', '#00ff80'],
                sunset: ['#ff0080', '#ff8000', '#ffff00'],
                forest: ['#004400', '#00ff00', '#88ff00'],
                neon: ['#ff00ff', '#00ffff', '#ff00ff']
            };

            const colors = presets[preset];
            if (!colors) return;

            // Update UI
            document.getElementById('gradientCount').value = colors.length;
            updateGradientCount();

            for (let i = 0; i < colors.length; i++) {
                document.getElementById('gradColor' + i).value = colors[i];
            }

            // Apply
            applyGradient();
        }

        // Save LED settings to localStorage
        function saveLedSettings() {
            const ledSettings = {
                mode: document.getElementById('ledMode').value,
                brightness: document.getElementById('ledBrightness').value,
                speed: document.getElementById('ledSpeed').value,
                color: document.getElementById('ledColor').value,
                gradientCount: document.getElementById('gradientCount').value,
                gradientColors: []
            };

            for (let i = 0; i < 5; i++) {
                ledSettings.gradientColors[i] = document.getElementById('gradColor' + i).value;
            }

            localStorage.setItem('ebikeLedSettings', JSON.stringify(ledSettings));
        }

        // Load LED settings from localStorage
        function loadLedSettings() {
            const saved = localStorage.getItem('ebikeLedSettings');
            if (saved) {
                const ledSettings = JSON.parse(saved);

                document.getElementById('ledMode').value = ledSettings.mode || '11';
                document.getElementById('ledBrightness').value = ledSettings.brightness || 200;
                document.getElementById('ledSpeed').value = ledSettings.speed || 128;
                document.getElementById('ledColor').value = ledSettings.color || '#00ffff';
                document.getElementById('gradientCount').value = ledSettings.gradientCount || 3;

                if (ledSettings.gradientColors) {
                    for (let i = 0; i < 5; i++) {
                        if (ledSettings.gradientColors[i]) {
                            document.getElementById('gradColor' + i).value = ledSettings.gradientColors[i];
                        }
                    }
                }

                updateGradientCount();
                setLedMode();
            }
        }

        // Initialize LED UI on page load
        function initLedUI() {
            loadLedSettings();
            // Default: show gradient section, hide solid color
            document.getElementById('gradientSection').style.display = 'block';
            document.getElementById('ledSolidColorItem').style.display = 'none';
            updateLedButtonText();
        }

        // Update LED quick button text
        function updateLedButtonText() {
            const mode = parseInt(document.getElementById('ledMode').value);
            const modeNames = {
                0: 'off', 1: 'solid', 2: 'breath', 3: 'rainbow',
                4: 'gear', 5: 'cadence', 6: 'speed', 9: 'strobe',
                10: 'candle', 11: 'gradient'
            };
            document.getElementById('ledModeText').textContent = modeNames[mode] || 'led';
        }

        // Cycle through LED modes with quick button
        function cycleLedMode() {
            const modes = [0, 11, 3, 2, 1, 4, 5, 6];  // Off, Gradient, Rainbow, Breathing, Solid, Gear, Cadence, Speed
            const currentMode = parseInt(document.getElementById('ledMode').value);
            const currentIndex = modes.indexOf(currentMode);
            const nextIndex = (currentIndex + 1) % modes.length;
            const nextMode = modes[nextIndex];

            document.getElementById('ledMode').value = nextMode;
            setLedMode();
            updateLedButtonText();
        }

        // ==================== START ====================
        init();
        initLedUI();
        runSimulation();

        // ==================== SERVICE WORKER ====================
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('Service Worker registered:', reg.scope))
                .catch(err => console.log('Service Worker registration failed:', err));
        }
    </script>
</body>
</html>
